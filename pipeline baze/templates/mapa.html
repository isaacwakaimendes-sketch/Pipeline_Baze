<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa em Ecr√£ Completo - Baze</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="fullscreen">
    <div class="fullscreen-container">
        <div class="map-header">
            <div class="header-left">
                <h1>üó∫Ô∏è Mapa da Rede de Monitoramento</h1>
            </div>
            <div class="header-center">
                <div class="dropdown">
                    <button class="dropdown-btn" id="layersBtn">
                        <span>üìã Camadas</span>
                        <span class="seta">‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="layersMenu">
                        <div class="dropdown-header">
                            <span>Camadas Ativas</span>
                            <button class="fechar-dropdown" id="fecharDropdown">‚úï</button>
                        </div>
                        <div class="dropdown-lista" id="layer-controls-container">
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="voltar-btn" onclick="window.location.href='/'">‚Üê Voltar √† P√°gina Principal</button>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-input-wrapper">
                <input type="text" class="search-input" placeholder="Pesquisar local..." id="searchInput">
                <button class="search-button" onclick="pesquisarLocal()">üîç</button>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <div id="fullscreen-map"></div>
    </div>

    <div class="dropdown-overlay" id="dropdownOverlay" onclick="fecharDropdown()"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
    let fullMap;
    let clusters = {};
    let allData = {apis: {}};
    let todosLocais = [];

    function initFullMap() {
        fullMap = L.map('fullscreen-map', {
            center: [41.15, -8.61],
            zoom: 11
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(fullMap);

        carregarDados();
        
        document.getElementById('searchInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                pesquisarLocal();
            }
        });

        setupDropdown();
    }

    function setupDropdown() {
        const btn = document.getElementById('layersBtn');
        const menu = document.getElementById('layersMenu');
        const fecharBtn = document.getElementById('fecharDropdown');

        btn.onclick = function(e) {
            e.stopPropagation();
            menu.classList.toggle('show');
        };

        fecharBtn.onclick = function(e) {
            e.stopPropagation();
            menu.classList.remove('show');
        };

        document.addEventListener('click', function(e) {
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        menu.onclick = function(e) {
            e.stopPropagation();
        };
    }

    function fecharDropdown() {
        document.getElementById('layersMenu').classList.remove('show');
    }

    async function carregarDados() {
        try {
            const response = await fetch('/api/dados');
            allData = await response.json();
            console.log('Dados carregados:', allData);
            
            atualizarCentroMapa(allData.config);
            criarCheckboxes(allData.config);
            criarClusters(allData.config);
            adicionarTodosMarcadores(allData.apis);
            prepararDadosBusca(allData.apis);
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
        }
    }

    function prepararDadosBusca(apis) {
        todosLocais = [];
        Object.entries(apis).forEach(([apiKey, pontos]) => {
            const config = allData.config?.apis?.[apiKey] || {};
            pontos.forEach(ponto => {
                todosLocais.push({
                    nome: ponto.local || 'Local n√£o identificado',
                    lat: ponto.lat,
                    lon: ponto.lon,
                    tipo: config.nome_amigavel || apiKey,
                    cor: config.cor || '#3498db',
                    data_hora: ponto.data_hora
                });
            });
        });
    }

    function pesquisarLocal() {
        const termo = document.getElementById('searchInput').value.trim().toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        
        if (termo.length < 2) {
            resultsDiv.innerHTML = '<div class="no-results">Digite pelo menos 2 caracteres</div>';
            resultsDiv.classList.add('show');
            return;
        }
        
        function normalizarTexto(texto) {
            return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        
        const termoNormalizado = normalizarTexto(termo);
        
        const resultados = todosLocais.filter(local => {
            const nomeNormalizado = normalizarTexto(local.nome.toLowerCase());
            return nomeNormalizado.includes(termoNormalizado);
        });
        
        if (resultados.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">Nenhum local encontrado</div>';
            resultsDiv.classList.add('show');
            return;
        }
        
        let html = '';
        resultados.forEach((local) => {
            html += `
                <div class="search-result-item" onclick="irParaLocal(${local.lat}, ${local.lon}, '${local.nome.replace(/'/g, "\\'")}')">
                    <div class="result-color" style="background: ${local.cor};"></div>
                    <div class="result-info">
                        <div class="result-name">${local.nome}</div>
                        <div class="result-type">${local.tipo}</div>
                        <div class="result-coords">${local.lat?.toFixed(6) || 'N/A'}, ${local.lon?.toFixed(6) || 'N/A'}</div>
                    </div>
                </div>
            `;
        });
        
        html += '<div class="close-results" onclick="fecharResultados()">‚úï Fechar</div>';
        
        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('show');
    }

    function irParaLocal(lat, lon, nome) {
        if (lat && lon) {
            fullMap.setView([lat, lon], 17);
        }
        fecharResultados();
        
        if (lat && lon) {
            const popup = L.popup()
                .setLatLng([lat, lon])
                .setContent(`<b>${nome}</b><br>Localizando...`)
                .openOn(fullMap);
            
            setTimeout(() => {
                fullMap.closePopup();
            }, 3000);
        }
    }

    function fecharResultados() {
        document.getElementById('searchResults').classList.remove('show');
        document.getElementById('searchInput').value = '';
    }

    function atualizarCentroMapa(config) {
        if (config?.mapa?.centro) {
            fullMap.setView(
                [config.mapa.centro.lat, config.mapa.centro.lon], 
                config.mapa.zoom || 11
            );
        }
    }

    function criarCheckboxes(config) {
        const container = document.getElementById('layer-controls-container');
        container.innerHTML = '';
        
        const apisOrdenadas = Object.entries(config.apis || {})
            .sort((a, b) => (a[1].ordem || 999) - (b[1].ordem || 999));
        
        apisOrdenadas.forEach(([apiKey, apiConfig]) => {
            if (!apiConfig.ativa) return;
            
            const label = document.createElement('label');
            label.className = 'layer-item';
            label.innerHTML = `
                <input type="checkbox" id="show-${apiKey}" checked onchange="toggleLayer('${apiKey}')">
                <span class="dot" style="background: ${apiConfig.cor};"></span>
                <span class="layer-name">${apiConfig.nome_amigavel}</span>
            `;
            container.appendChild(label);
        });
    }

    function criarClusters(config) {
        Object.entries(config.apis || {}).forEach(([apiKey, apiConfig]) => {
            if (!apiConfig.ativa) return;
            
            clusters[apiKey] = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    return L.divIcon({
                        html: `<div style="background-color: ${apiConfig.cor}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${cluster.getChildCount()}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: L.point(30, 30)
                    });
                }
            });
            
            fullMap.addLayer(clusters[apiKey]);
        });
    }

    function adicionarTodosMarcadores(apis) {
        Object.entries(clusters).forEach(([apiKey, cluster]) => {
            cluster.clearLayers();
        });

        Object.entries(apis).forEach(([apiKey, pontos]) => {
            if (!clusters[apiKey]) return;
            
            const markers = [];
            pontos.forEach(ponto => {
                if (ponto.lat && ponto.lon) {
                    const marker = L.circleMarker([ponto.lat, ponto.lon], {
                        radius: 8,
                        fillColor: ponto.cor,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    const popupContent = criarPopupContent(ponto, apiKey);
                    marker.bindPopup(popupContent);
                    markers.push(marker);
                }
            });

            clusters[apiKey].addLayers(markers);
        });
    }

    function criarPopupContent(ponto, apiKey) {
        const config = allData.config?.apis?.[apiKey] || {};
        const tipoAmigavel = config.nome_amigavel || apiKey;
        const cor = config.cor || '#3498db';
        
        let html = `<div class="popup-content">`;
        html += `<h3>${ponto.local || 'Local n√£o identificado'}</h3>`;
        html += `<p class="popup-type" style="color: ${cor}; font-weight: bold; border-left: 4px solid ${cor}; padding-left: 8px; margin: 10px 0; background-color: #f8f9fa; padding: 8px 12px; border-radius: 6px;">`;
        html += `<strong>Tipo:</strong> ${tipoAmigavel}`;
        html += `</p>`;
        
        html += `<div class="popup-dados-essenciais" style="background-color: #f0f7ff; padding: 10px; border-radius: 6px; margin-bottom: 12px;">`;
        html += `<p style="margin: 4px 0;"><strong>üìÖ Data/Hora:</strong> ${ponto.data_hora || 'N/A'}</p>`;
        html += `<p style="margin: 4px 0;"><strong>üìç Longitude:</strong> ${ponto.lon?.toFixed(6) || 'N/A'}</p>`;
        html += `<p style="margin: 4px 0;"><strong>üìç Latitude:</strong> ${ponto.lat?.toFixed(6) || 'N/A'}</p>`;
        html += `</div>`;
        
        if (ponto.dados && Object.keys(ponto.dados).length > 0) {
            html += `<div class="popup-dados-ambientais">`;
            html += `<p style="margin: 4px 0 8px 0; font-weight: bold; color: #555;">üìä Dados:</p>`;
            
            for (const [chave, valor] of Object.entries(ponto.dados)) {
                html += `<p style="margin: 4px 0;"><strong>${chave}:</strong> ${valor}</p>`;
            }
            
            html += `</div>`;
        }
        
        html += `</div>`;
        return html;
    }

    function toggleLayer(apiKey) {
        const checkbox = document.getElementById(`show-${apiKey}`);
        const cluster = clusters[apiKey];
        
        if (!cluster) return;
        
        if (checkbox.checked) {
            if (!fullMap.hasLayer(cluster)) fullMap.addLayer(cluster);
        } else {
            if (fullMap.hasLayer(cluster)) fullMap.removeLayer(cluster);
        }
    }

    window.addEventListener('load', initFullMap);
    </script>
</body>
</html>